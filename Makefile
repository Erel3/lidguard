APP_NAME = LidGuard
BUNDLE = dist/$(APP_NAME).app
BUILD_DIR = .build/release
VERSION_FILE = VERSION
BUMP ?= patch
CODESIGN_ID ?= LidGuard
CODESIGN_REQ ?= designated => certificate leaf = H"9787B7F0A9496DF5757D22D586EA8C0735656867"

.PHONY: build run run-debug install release clean version icon

VERSION := $(shell cat $(VERSION_FILE) 2>/dev/null || echo "1.0.0")

build:
	swift build -c release

# Dev: bundle with -dev suffix and open
run: build
	@$(MAKE) _bundle SUFFIX=-dev
	open $(BUNDLE)

# Debug: build debug binary and run directly (no .app bundle)
run-debug:
	swift build && .build/debug/$(APP_NAME)

# Install current bundle to /Applications
install:
	@test -d $(BUNDLE) || (echo "Error: No bundle found. Run 'make run' or 'make release' first." && exit 1)
	@VERSION=$$(plutil -extract CFBundleShortVersionString raw $(BUNDLE)/Contents/Info.plist); \
	echo "Installing $(APP_NAME) v$$VERSION to /Applications"
	rm -rf /Applications/$(APP_NAME).app
	cp -r $(BUNDLE) /Applications/

# Release: bump version, build prod, commit, tag, push, create GH release
#   BUMP=minor make release                          — bump minor
#   TITLE="Big Update" make release                  — custom title
#   Requires RELEASE_NOTES.md (deleted after publish)
release:
	@test -f RELEASE_NOTES.md || (echo "Error: RELEASE_NOTES.md is required. Write release notes first." && exit 1)
	@$(MAKE) _bump
	@$(MAKE) build
	@$(MAKE) _bundle SUFFIX=
	@VERSION=$$(cat $(VERSION_FILE)); \
	TITLE="$${TITLE:-v$$VERSION}"; \
	git add $(VERSION_FILE) && \
	git commit -m "chore: bump version to $$VERSION" && \
	git tag "v$$VERSION" && \
	cd dist && zip -r $(APP_NAME)-$$VERSION.zip $(APP_NAME).app && cd .. && \
	git push origin main --tags && \
	gh release create "v$$VERSION" "dist/$(APP_NAME)-$$VERSION.zip" \
		--title "$$TITLE" --notes-file RELEASE_NOTES.md && \
	rm -f RELEASE_NOTES.md && \
	echo "Released v$$VERSION"

# Internal: create .app bundle with optional SUFFIX (-dev or empty)
_bundle:
	@VERSION=$$(cat $(VERSION_FILE))$(SUFFIX); \
	echo "Bundling $(APP_NAME) v$$VERSION"; \
	rm -rf $(BUNDLE); \
	mkdir -p $(BUNDLE)/Contents/MacOS $(BUNDLE)/Contents/Resources; \
	cp $(BUILD_DIR)/$(APP_NAME) $(BUNDLE)/Contents/MacOS/; \
	sed -e "s/<string>1.0.0</<string>$$VERSION</" \
	    -e "s/<string>1</<string>$$(echo $$VERSION | tr -d '.-dev')</" \
	    Info.plist > $(BUNDLE)/Contents/Info.plist; \
	cp Resources/AppIcon.icns $(BUNDLE)/Contents/Resources/ 2>/dev/null || true; \
	codesign --force --sign "$(CODESIGN_ID)" --entitlements LidGuard.entitlements \
		-o runtime --timestamp=none \
		-r='$(CODESIGN_REQ)' \
		$(BUNDLE); \
	echo "Built: $(BUNDLE) v$$VERSION"

_bump:
	@VERSION=$$(cat $(VERSION_FILE) | sed 's/-dev//'); \
	MAJOR=$$(echo $$VERSION | cut -d. -f1); \
	MINOR=$$(echo $$VERSION | cut -d. -f2); \
	PATCH=$$(echo $$VERSION | cut -d. -f3); \
	case "$(BUMP)" in \
		major) MAJOR=$$((MAJOR + 1)); MINOR=0; PATCH=0;; \
		minor) MINOR=$$((MINOR + 1)); PATCH=0;; \
		patch) PATCH=$$((PATCH + 1));; \
	esac; \
	echo "$$MAJOR.$$MINOR.$$PATCH" > $(VERSION_FILE); \
	echo "Version bumped to $$MAJOR.$$MINOR.$$PATCH"

icon:
	swift Scripts/generate_icon.swift

clean:
	rm -rf .build dist

version:
	@cat $(VERSION_FILE)
